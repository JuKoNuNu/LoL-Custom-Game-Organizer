<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‚´ì „ ë°¸ëŸ°ìŠ¤ ë©”ì´ì»¤</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #0a0e1a;
  --surface:   #111625;
  --card:      #161d30;
  --border:    #252f4a;
  --gold:      #c8a84b;
  --gold-l:    #e8c86b;
  --text:      #dde4f0;
  --muted:     #7a8aaa;
  --IRON:      #8d8d8d;
  --BRONZE:    #cd7f32;
  --SILVER:    #a8a9ad;
  --GOLD:      #d4af37;
  --PLATINUM:  #009688;
  --EMERALD:   #3ecf78;
  --DIAMOND:   #4fc3f7;
  --MASTER:    #ab47bc;
  --GRANDMASTER: #ef5350;
  --CHALLENGER:  #ffe066;
}

body {
  font-family: 'Noto Sans KR', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding-bottom: 80px;
}

/* â”€â”€ HEADER â”€â”€ */
header {
  background: linear-gradient(135deg, #111625 0%, #1b2c50 100%);
  border-bottom: 2px solid var(--gold);
  padding: 22px 24px;
  text-align: center;
}
header h1 { font-size: 1.75rem; color: var(--gold-l); font-weight: 700; letter-spacing: 2px; }
header p  { color: var(--muted); font-size: 0.82rem; margin-top: 4px; }

/* â”€â”€ LAYOUT â”€â”€ */
.wrap { max-width: 1440px; margin: 0 auto; padding: 0 16px; }
section { margin-top: 28px; }

.sec-title {
  font-size: 1rem; font-weight: 700; color: var(--gold);
  border-left: 3px solid var(--gold);
  padding-left: 10px; margin-bottom: 14px;
}

/* â”€â”€ INPUT â”€â”€ */
.input-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
.input-row input {
  flex: 1; min-width: 240px;
  background: var(--card); border: 1px solid var(--border); border-radius: 6px;
  padding: 10px 14px; color: var(--text); font-size: 0.95rem;
  font-family: inherit; outline: none; transition: border-color .2s;
}
.input-row input:focus { border-color: var(--gold); }
.input-row input::placeholder { color: var(--muted); }

.btn {
  padding: 10px 18px; border: none; border-radius: 6px;
  font-size: 0.9rem; font-weight: 600; cursor: pointer;
  transition: all .2s; font-family: inherit;
}
.btn-gold  { background: var(--gold); color: #0a0e1a; }
.btn-gold:hover { background: var(--gold-l); }
.btn-gold:disabled { opacity: .45; cursor: not-allowed; }
.btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--muted); }
.btn-ghost:hover { border-color: var(--muted); color: var(--text); }
.btn-green { background: #245c3a; color: #7af0a8; font-size: 1rem; padding: 11px 28px; }
.btn-green:hover { background: #2e7a4e; }
.btn-rm    { background: transparent; border: 1px solid #555; color: #888; padding: 3px 9px; font-size: 0.78rem; border-radius: 4px; }
.btn-rm:hover { border-color: #ef5350; color: #ef5350; }
.btn-discord { background: #5865F2; color: white; margin-left: 10px; font-size: 0.82rem; padding: 6px 12px; }
.btn-discord:hover { background: #4752C4; }

.err { color: #ef5350; font-size: 0.82rem; margin-top: 6px; min-height: 18px; }

/* â”€â”€ MAIN GRID â”€â”€ */
.main-grid {
  display: grid;
  grid-template-columns: 1fr 350px;
  gap: 20px; align-items: start;
}
@media (max-width: 960px) { .main-grid { grid-template-columns: 1fr; } }

/* â”€â”€ PLAYER CARDS â”€â”€ */
.players-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
  gap: 12px;
}
.empty-state {
  color: var(--muted); font-size: 0.9rem;
  padding: 40px 20px; text-align: center; line-height: 1.8;
  border: 1px dashed var(--border); border-radius: 10px;
}

.p-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 10px; padding: 14px; position: relative;
  transition: border-color .2s;
}
.p-card.sel { border-color: var(--gold); }

.p-card-top { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.p-icon {
  width: 44px; height: 44px; border-radius: 50%;
  border: 2px solid var(--border); object-fit: cover; flex-shrink: 0;
}
.p-name { font-weight: 700; font-size: 0.88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.p-sub  { font-size: 0.72rem; color: var(--muted); }

.tier-badge {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 0.78rem; font-weight: 700; margin: 2px 0;
}
.lane-tag {
  display: inline-block; padding: 2px 7px; border-radius: 4px;
  font-size: 0.75rem; font-weight: 600;
  background: var(--bg); border: 1px solid var(--border); color: var(--muted);
  margin-left: 4px;
}
.stats-row {
  display: flex; justify-content: space-between; align-items: center;
  margin-top: 8px; font-size: 0.78rem; color: var(--muted);
}
.p-score { font-size: 1.05rem; font-weight: 700; color: var(--gold); }
.card-btns { position: absolute; top: 8px; right: 8px; }

/* â”€â”€ CHAMPION ICONS â”€â”€ */
.champ-row { display: flex; gap: 6px; margin-top: 8px; }
.champ-wrap {
  position: relative; flex-shrink: 0;
  width: 40px; cursor: default;
}
.champ-wrap img {
  width: 40px; height: 40px; border-radius: 6px;
  border: 1px solid var(--border); display: block;
  object-fit: cover;
}
.champ-lv {
  position: absolute; bottom: -2px; right: -2px;
  background: rgba(10, 14, 26, 0.9); border: 1px solid var(--gold);
  border-radius: 3px; font-size: 0.6rem; font-weight: 700;
  padding: 0 2px; line-height: 12px; color: var(--gold);
  z-index: 2;
}
.champ-tooltip {
  display: none; position: absolute; bottom: 110%; left: 50%;
  transform: translateX(-50%);
  background: #0a0e1a; border: 1px solid var(--border);
  border-radius: 6px; padding: 4px 8px;
  font-size: 0.72rem; white-space: nowrap;
  color: var(--text); z-index: 10;
}
.champ-wrap:hover .champ-tooltip { display: block; }

/* â”€â”€ MATCH HISTORY â”€â”€ */
.matches-toggle {
  width: 100%; background: var(--surface); border: none;
  color: var(--muted); font-size: 0.78rem; font-family: inherit;
  padding: 6px 10px; cursor: pointer; text-align: left;
  display: flex; justify-content: space-between; align-items: center;
  margin-top: 8px; border-radius: 6px; transition: background .2s;
}
.matches-toggle:hover { background: #1c2540; color: var(--text); }
.matches-list { margin-top: 6px; display: none; }
.matches-list.open { display: block; }
.match-row {
  display: flex; align-items: center; gap: 5px;
  padding: 4px 2px; border-bottom: 1px solid #1c2438; font-size: 0.74rem;
}
.match-champ { width: 28px; height: 28px; border-radius: 4px; flex-shrink: 0; }
.match-wl { width: 20px; text-align: center; font-weight: 700; font-size: 0.72rem; flex-shrink: 0; }
.match-wl.w { color: #4fc3f7; }
.match-wl.l { color: #ef5350; }
.match-name { flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; }
.match-kda { color: var(--gold); font-weight: 700; flex-shrink: 0; }
.match-meta { color: var(--muted); flex-shrink: 0; }

/* â”€â”€ MATCH ITEMS â”€â”€ */
.match-items { display: flex; gap: 2px; margin-top: 4px; padding-left: 33px; }
.match-item { 
  width: 18px; height: 18px; border-radius: 2px; 
  border: 1px solid var(--border); background: var(--bg);
}

.tl-btn {
  background: transparent; border: 1px solid var(--border); color: var(--muted);
  font-size: 0.68rem; padding: 1px 5px; border-radius: 3px; cursor: pointer;
  flex-shrink: 0; font-family: inherit;
}
.tl-btn:hover { border-color: var(--gold); color: var(--gold); }
/* íƒ€ì„ë¼ì¸ */
.tl-section {
  display: none; background: var(--bg); border-radius: 6px;
  padding: 6px 8px; margin: 2px 0 4px; border: 1px solid var(--border);
}
.tl-section.open { display: block; }
.tl-row { display: flex; align-items: center; gap: 6px; padding: 2px 0; font-size: 0.72rem; }
.tl-min { color: var(--gold); font-weight: 700; width: 26px; flex-shrink: 0; }
.tl-icon { width: 20px; height: 20px; border-radius: 3px; flex-shrink: 0; }
.tl-label { color: var(--muted); }

/* â”€â”€ CHART CARD â”€â”€ */
.chart-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 10px; padding: 16px;
  display: flex; flex-direction: column;
}
.chart-card h3 { font-size: 0.9rem; color: var(--gold); margin-bottom: 12px; }
.chart-container { position: relative; width: 100%; }

/* â”€â”€ LANE RANKINGS â”€â”€ */
.lanes-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 12px;
}
@media (max-width: 900px) { .lanes-grid { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 560px) { .lanes-grid { grid-template-columns: repeat(2, 1fr); } }

.lane-col {
  background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden;
}
.lane-head {
  background: var(--surface); padding: 8px 12px;
  font-weight: 700; font-size: 0.88rem; text-align: center;
  border-bottom: 1px solid var(--border);
}
.lane-row {
  padding: 8px 12px; border-bottom: 1px solid #1c2438;
  display: flex; align-items: center; gap: 6px;
}
.lane-row:last-child { border-bottom: none; }
.lane-num { font-size: 0.75rem; color: var(--muted); font-weight: 700; width: 14px; flex-shrink: 0; }
.lane-info { flex: 1; min-width: 0; }
.lane-pname { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.lane-tier  { font-size: 0.72rem; }
.lane-tier-badge {
  display: inline-block; padding: 1px 6px; border-radius: 3px;
  font-size: 0.65rem; font-weight: 800; margin-left: 4px;
  letter-spacing: 1px;
}
.lane-score { font-size: 0.78rem; font-weight: 700; color: var(--gold); }
.lane-empty { padding: 12px; text-align: center; color: var(--muted); font-size: 0.8rem; }

/* â”€â”€ BALANCE â”€â”€ */
.toggle-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px; }
.p-toggle {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 6px; padding: 6px 12px;
  font-size: 0.83rem; color: var(--muted); cursor: pointer;
  user-select: none; transition: all .2s;
}
.p-toggle.on { border-color: var(--gold); color: var(--text); background: #1a2c48; }

.balance-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.sel-count { font-size: 0.82rem; color: var(--muted); }
.sel-count.warn { color: #ef5350; }

/* â”€â”€ TEAMS â”€â”€ */
.teams-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;
}
@media (max-width: 600px) { .teams-grid { grid-template-columns: 1fr; } }

.team-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 10px; overflow: hidden;
}
.team-head {
  padding: 10px 16px; font-weight: 700; font-size: 0.92rem;
  display: flex; justify-content: space-between; align-items: center;
}
.t1 .team-head { background: #142040; border-bottom: 2px solid #4fc3f7; }
.t2 .team-head { background: #2a1010; border-bottom: 2px solid #ef5350; }

.team-player {
  padding: 10px 14px; border-bottom: 1px solid #1c2438;
  display: flex; align-items: center; gap: 10px;
}
.team-player:last-child { border-bottom: none; }
.team-icon { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); }
.team-player-info { flex: 1; min-width: 0; }
.team-player-name { font-size: 0.85rem; font-weight: 600; }
.team-player-tier { font-size: 0.75rem; }
.team-player-score { font-size: 0.82rem; font-weight: 700; color: var(--gold); text-align: right; }

.team-foot {
  padding: 8px 16px; background: var(--surface);
  font-size: 0.82rem; display: flex; justify-content: space-between; color: var(--muted);
}

.diff-banner {
  grid-column: 1 / -1;
  text-align: center; padding: 10px;
  background: var(--surface); border-radius: 8px;
  font-size: 0.88rem; color: var(--muted);
}

/* â”€â”€ MISC â”€â”€ */
.spinner {
  display: inline-block; width: 13px; height: 13px;
  border: 2px solid #2a3550; border-top-color: var(--gold);
  border-radius: 50%; animation: spin .7s linear infinite; vertical-align: middle;
}
@keyframes spin { to { transform: rotate(360deg); } }

.loading-box {
  text-align: center; color: var(--muted); padding: 30px;
  font-size: 0.9rem;
}

/* â”€â”€ SAVED SUMMONERS â”€â”€ */
.saved-list { display: flex; flex-wrap: wrap; gap: 8px; }
.saved-item {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 8px; padding: 8px 12px;
  display: flex; align-items: center; gap: 10px;
}
.saved-item-info { min-width: 0; flex: 1; }
.saved-item-name { font-weight: 600; font-size: 0.83rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.saved-item-meta { font-size: 0.7rem; }
.btn-icon {
  background: transparent; border: 1px solid var(--border); color: var(--muted);
  padding: 3px 8px; font-size: 0.82rem; border-radius: 4px; cursor: pointer;
  transition: all .2s; font-family: inherit;
}
.btn-icon:hover { border-color: var(--gold); color: var(--gold); }
.btn-icon:disabled { opacity: .4; cursor: not-allowed; }

/* â”€â”€ CONSTRAINT GROUPS â”€â”€ */
.constraint-section {
  margin-top: 16px; padding: 14px;
  background: var(--card); border: 1px solid var(--border); border-radius: 10px;
}
.constraint-title {
  font-size: 0.85rem; font-weight: 700; margin-bottom: 8px;
  display: flex; align-items: center; gap: 8px; cursor: pointer;
  user-select: none;
}
.constraint-title .arrow { transition: transform .2s; font-size: 0.7rem; }
.constraint-title .arrow.open { transform: rotate(90deg); }
.constraint-body { display: none; }
.constraint-body.open { display: block; }
.constraint-desc {
  font-size: 0.72rem; color: var(--muted); margin-bottom: 10px; line-height: 1.5;
}
.group-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; padding: 10px 12px; margin-bottom: 8px;
}
.group-header {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;
}
.group-label { font-size: 0.8rem; font-weight: 700; }
.group-members { display: flex; flex-wrap: wrap; gap: 6px; }
.group-member {
  display: flex; align-items: center; gap: 4px;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 4px; padding: 3px 8px; font-size: 0.75rem;
}
.group-member .rm {
  cursor: pointer; color: var(--muted); font-size: 0.7rem; margin-left: 2px;
}
.group-member .rm:hover { color: #ef5350; }
.group-add-btn {
  background: transparent; border: 1px dashed var(--border);
  border-radius: 4px; padding: 3px 8px; font-size: 0.75rem;
  color: var(--gold); cursor: pointer; font-family: inherit;
}
.group-add-btn:hover { border-color: var(--gold); }
.add-group-btn {
  background: transparent; border: 1px dashed var(--border);
  border-radius: 8px; padding: 8px; text-align: center;
  font-size: 0.78rem; color: var(--muted); cursor: pointer;
  font-family: inherit; width: 100%;
}
.add-group-btn:hover { border-color: var(--gold); color: var(--gold); }
.group-player-select {
  position: absolute; background: var(--card); border: 1px solid var(--border);
  border-radius: 6px; padding: 6px; z-index: 100; min-width: 160px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.group-player-option {
  padding: 5px 10px; font-size: 0.78rem; cursor: pointer;
  border-radius: 4px; transition: background .15s;
}
.group-player-option:hover { background: var(--surface); }
.group-player-option.disabled { opacity: .35; cursor: not-allowed; }
</style>
</head>
<body>

<header>
  <h1>âš” ë‚´ì „ ë°¸ëŸ°ìŠ¤ ë©”ì´ì»¤</h1>
  <p>ë¼ì´ì—‡ ê³„ì • ì •ë³´ ê¸°ë°˜ Â· ë¼ì¸ë³„ í‹°ì–´ ìˆœìœ„ Â· ìë™ íŒ€ êµ¬ì„±</p>
</header>

<div class="wrap">

  <!-- â”€â”€ ì…ë ¥ â”€â”€ -->
  <section>
    <div class="sec-title">í”Œë ˆì´ì–´ ì¶”ê°€</div>
    <div class="input-row">
      <input id="riotInput" type="text" placeholder="ë‹‰ë„¤ì„#íƒœê·¸  (ì˜ˆ: Hide on bush#KR1)" />
      <button class="btn btn-gold" id="addBtn" onclick="addPlayer()">ì¶”ê°€</button>
      <button class="btn btn-ghost" onclick="clearAll()">ì „ì²´ ì‚­ì œ</button>
    </div>
    <div class="err" id="inputErr"></div>
  </section>

  <!-- â”€â”€ ì €ì¥ëœ ì†Œí™˜ì‚¬ â”€â”€ -->
  <section id="savedSection" style="display:none">
    <div class="sec-title" style="display:flex;align-items:center;gap:12px">
      ì €ì¥ëœ ì†Œí™˜ì‚¬
      <span style="color:var(--muted);font-weight:400;font-size:0.78rem">ìºì‹œì—ì„œ ë°”ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°</span>
      <button class="btn btn-gold" id="loadAllBtn" onclick="loadAllSaved()" style="margin-left:8px;padding:4px 12px;font-size:0.78rem">
        ì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸°
      </button>
      <button class="btn-icon" id="refreshAllBtn" onclick="refreshAllSaved()" style="margin-left:auto;padding:4px 12px;font-size:0.78rem">
        â†» ì „ì²´ ìƒˆë¡œê³ ì¹¨
      </button>
    </div>
    <div class="saved-list" id="savedList"></div>
  </section>

  <!-- â”€â”€ í”Œë ˆì´ì–´ ëª©ë¡ + ì°¨íŠ¸ â”€â”€ -->
  <section>
    <div class="sec-title">
      í”Œë ˆì´ì–´ ëª©ë¡
      <span id="pCount" style="color:var(--muted);font-weight:400;font-size:0.85rem;"></span>
    </div>
    <div class="main-grid">
      <div>
        <div class="empty-state" id="emptyState">
          ì•„ì§ ì¶”ê°€ëœ í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤<br>
          ìœ„ì—ì„œ ë‹‰ë„¤ì„#íƒœê·¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”
        </div>
        <div id="playersGrid" class="players-grid"></div>
      </div>
      <div class="chart-card" id="chartCard" style="display:none">
        <h3>íŒŒì›Œ ê·¸ë˜í”„ (ìµœê³  í‹°ì–´ ê¸°ì¤€)</h3>
        <div class="chart-container">
          <canvas id="scoreChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- â”€â”€ ë¼ì¸ë³„ ìˆœìœ„ â”€â”€ -->
  <section id="laneSection" style="display:none">
    <div class="sec-title">ë¼ì¸ë³„ í‹°ì–´ ìˆœìœ„</div>
    <div class="lanes-grid">
      <div class="lane-col" id="lane-TOP">    <div class="lane-head">íƒ‘</div></div>
      <div class="lane-col" id="lane-JUNGLE"> <div class="lane-head">ì •ê¸€</div></div>
      <div class="lane-col" id="lane-MIDDLE"> <div class="lane-head">ë¯¸ë“œ</div></div>
      <div class="lane-col" id="lane-BOTTOM"> <div class="lane-head">ì›ë”œ</div></div>
      <div class="lane-col" id="lane-UTILITY"><div class="lane-head">ì„œí¬í„°</div></div>
    </div>
  </section>

  <!-- â”€â”€ íŒ€ êµ¬ì„± â”€â”€ -->
  <section id="balanceSection" style="display:none">
    <div class="sec-title">íŒ€ ìë™ êµ¬ì„±</div>
    <p style="color:var(--muted);font-size:0.82rem;margin-bottom:12px">
      ì°¸ì—¬í•  í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”. ì§ìˆ˜ ì¸ì›ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
    </p>
    <div class="toggle-grid" id="toggleGrid"></div>
    <div class="balance-controls">
      <button class="btn btn-green" onclick="balanceTeams('balance')">âš– ë°¸ëŸ°ìŠ¤ íŒ€ ì§œê¸°</button>
      <button class="btn btn-ghost" style="padding:11px 18px" onclick="balanceTeams('random')">ğŸ² ì™„ì „ ëœë¤</button>
      <button class="btn btn-ghost" style="padding:11px 18px" onclick="balanceTeams('random_lane')">ğŸ”€ ëœë¤ + ë¼ì¸ë°°ì •</button>
      <span class="sel-count" id="selCount"></span>
    </div>

    <!-- ê³ ì •ê·¸ë£¹ -->
    <div class="constraint-section" style="margin-top:14px">
      <div class="constraint-title" onclick="toggleConstraint('fixed')">
        <span class="arrow" id="fixedArrow">â–¶</span>
        <span style="color:var(--gold)">ê³ ì •ê·¸ë£¹</span>
        <span id="fixedGroupCount" style="color:var(--muted);font-weight:400;font-size:0.75rem"></span>
      </div>
      <div class="constraint-body" id="fixedBody">
        <div class="constraint-desc">
          * ê°™ì€ íŒ€ì— ë°˜ë“œì‹œ ë°°ì •ë˜ì–´ì•¼ í•˜ëŠ” ì¸ì›ë“¤ì„ ê°™ì€ ê·¸ë£¹ì— ë„£ì–´ ì„¤ì •í•˜ì„¸ìš”.
        </div>
        <div id="fixedGroups"></div>
        <button class="add-group-btn" onclick="addGroup('fixed')">+ ê³ ì •ê·¸ë£¹ ì¶”ê°€</button>
      </div>
    </div>

    <!-- ë¶„ë¦¬ê·¸ë£¹ -->
    <div class="constraint-section" style="margin-top:8px">
      <div class="constraint-title" onclick="toggleConstraint('separate')">
        <span class="arrow" id="separateArrow">â–¶</span>
        <span style="color:#ef5350">ë¶„ë¦¬ê·¸ë£¹</span>
        <span id="separateGroupCount" style="color:var(--muted);font-weight:400;font-size:0.75rem"></span>
      </div>
      <div class="constraint-body" id="separateBody">
        <div class="constraint-desc">
          * ì„œë¡œ ì°¢ì–´ì¡Œìœ¼ë©´ í•˜ëŠ” ì¸ì›ë“¤ì„ ê°™ì€ ê·¸ë£¹ì— ë„£ì–´ ì„¤ì •í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
        </div>
        <div id="separateGroups"></div>
        <button class="add-group-btn" onclick="addGroup('separate')">+ ë¶„ë¦¬ê·¸ë£¹ ì¶”ê°€</button>
      </div>
    </div>

    <div id="teamsResult"></div>
  </section>

</div><!-- /wrap -->

<script>
// â”€â”€ ìƒìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TIER_KO = {
  IRON:'ì•„ì´ì–¸', BRONZE:'ë¸Œë¡ ì¦ˆ', SILVER:'ì‹¤ë²„', GOLD:'ê³¨ë“œ',
  PLATINUM:'í”Œë˜í‹°ë„˜', EMERALD:'ì—ë©”ë„ë“œ', DIAMOND:'ë‹¤ì´ì•„',
  MASTER:'ë§ˆìŠ¤í„°', GRANDMASTER:'ê·¸ëœë“œë§ˆìŠ¤í„°', CHALLENGER:'ì±Œë¦°ì €',
};
const RANK_KO  = { I:'1', II:'2', III:'3', IV:'4' };
const LANE_KO  = { TOP:'íƒ‘', JUNGLE:'ì •ê¸€', MIDDLE:'ë¯¸ë“œ', BOTTOM:'ì›ë”œ', UTILITY:'ì„œí¬í„°', UNKNOWN:'ë¯¸ì •' };
const LANES    = ['TOP','JUNGLE','MIDDLE','BOTTOM','UTILITY'];
const T_COLOR  = {
  IRON:'#8d8d8d', BRONZE:'#cd7f32', SILVER:'#a8a9ad', GOLD:'#d4af37',
  PLATINUM:'#009688', EMERALD:'#3ecf78', DIAMOND:'#4fc3f7',
  MASTER:'#ab47bc', GRANDMASTER:'#ef5350', CHALLENGER:'#ffe066',
};

// â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let players  = [];    // ì „ì²´ í”Œë ˆì´ì–´ ë°°ì—´
let selected = new Set(); // displayName ì§‘í•©
let chart    = null;

// â”€â”€ í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tc(tier) { return T_COLOR[tier] || '#666'; }

function tierLabel(entry) {
  if (!entry) return 'ì–¸ë­';
  const { tier, rank, lp } = entry;
  if (['MASTER','GRANDMASTER','CHALLENGER'].includes(tier))
    return `${TIER_KO[tier]} ${lp}LP`;
  return `${TIER_KO[tier]} ${RANK_KO[rank]} (${lp}LP)`;
}

function esc(s) { return s.replace(/'/g, "\\'"); }

// â”€â”€ í”Œë ˆì´ì–´ ì¶”ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addPlayer() {
  const input  = document.getElementById('riotInput');
  const btn    = document.getElementById('addBtn');
  const errEl  = document.getElementById('inputErr');
  const val    = input.value.trim();
  errEl.textContent = '';

  if (!val) { errEl.textContent = 'ë‹‰ë„¤ì„#íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'; return; }
  if (!val.includes('#')) { errEl.textContent = 'í˜•ì‹: ë‹‰ë„¤ì„#íƒœê·¸ (ì˜ˆ: Hide on bush#KR1)'; return; }
  if (players.find(p => p.displayName.toLowerCase() === val.toLowerCase())) {
    errEl.textContent = 'ì´ë¯¸ ì¶”ê°€ëœ í”Œë ˆì´ì–´ì…ë‹ˆë‹¤'; return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> ì¡°íšŒ ì¤‘â€¦';

  try {
    const res  = await fetch(`/api/player/${encodeURIComponent(val)}`);
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.error || 'ì˜¤ë¥˜ ë°œìƒ'; return; }
    players.push(data);
    selected.add(data.displayName);
    input.value = '';
    renderAll();
    loadSavedPlayers();
  } catch (e) {
    errEl.textContent = 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ' + e.message;
  } finally {
    btn.disabled = false;
    btn.textContent = 'ì¶”ê°€';
  }
}

function removePlayer(dn) {
  players = players.filter(p => p.displayName !== dn);
  selected.delete(dn);
  renderAll();
  loadSavedPlayers();
}

function clearAll() {
  if (!players.length) return;
  if (!confirm('ëª¨ë“  í”Œë ˆì´ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  players = []; selected.clear(); renderAll();
}

// â”€â”€ ì „ì²´ ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  renderCards();
  renderChart();
  renderLanes();
  renderToggles();
  updateSelCount();
  cleanupGroups();
  document.getElementById('pCount').textContent = players.length ? `(${players.length}ëª…)` : '';
  document.getElementById('laneSection').style.display    = players.length   ? '' : 'none';
  document.getElementById('balanceSection').style.display = players.length >= 2 ? '' : 'none';
  document.getElementById('teamsResult').innerHTML = '';
}

// â”€â”€ í”Œë ˆì´ì–´ ì¹´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCards() {
  const grid  = document.getElementById('playersGrid');
  const empty = document.getElementById('emptyState');
  const chart = document.getElementById('chartCard');

  if (!players.length) {
    grid.innerHTML = '';
    empty.style.display = '';
    chart.style.display = 'none';
    return;
  }
  empty.style.display = 'none';
  chart.style.display = '';

  const sorted = [...players].sort((a, b) => b.score - a.score);

  grid.innerHTML = sorted.map(p => {
    const rank  = p.highestRank;
    const tier  = rank?.tier || null;
    const color = tc(tier);
    const isSel = selected.has(p.displayName);
    const wr    = rank?.winRate;
    const wrColor = wr >= 55 ? '#3ecf78' : wr >= 50 ? '#dde4f0' : '#ef5350';

    return `
    <div class="p-card${isSel ? ' sel' : ''}">
      <div class="p-card-top">
        <img class="p-icon" src="${p.iconUrl}"
          onerror="this.src='https://ddragon.leagueoflegends.com/cdn/15.4.1/img/profileicon/29.png'" alt="">
        <div style="min-width:0">
          <div class="p-name" title="${p.displayName}">${p.gameName}${p.fromCache ? `<span style="font-size:0.58rem;color:var(--muted);background:var(--surface);border:1px solid var(--border);padding:1px 5px;border-radius:3px;margin-left:5px;vertical-align:middle" title="ìºì‹œë¨: ${p.cachedAt}">ìºì‹œ</span>` : ''}</div>
          <div class="p-sub">Lv.${p.level} Â· #${p.tagLine} Â· <span style="font-weight:700;color:var(--gold)">${p.score.toLocaleString()}pt</span></div>
          <div style="margin-top:4px"><span class="lane-tag">${p.primaryLaneKo} (${p.primaryLaneWr || 0}%)</span></div>
        </div>
        <div class="p-score" style="margin-left:auto;font-size:1.1rem;font-weight:700;color:var(--gold)">${p.score.toLocaleString()}</div>
      </div>

      ${rank ? `
        <div style="margin-bottom:8px">
          <span class="tier-badge" style="background:${color}22;color:${color}">
            ${tierLabel(rank)}
          </span>
          <span style="font-size:.72rem;color:var(--muted)"> ${rank.queueType}</span>
        </div>
      ` : `
        <div style="color:var(--muted);font-size:.82rem;margin:4px 0">ì–¸ë­í¬</div>
      `}

      ${(() => {
        const uid = `pl${players.indexOf(p)}`;
        const totalScan = p.totalMatches || 30;
        const laneOrder = ['TOP','JUNGLE','MIDDLE','BOTTOM','UTILITY'];
        
        // 1. ë¼ì¸ë³„ ìƒì„¸
        const laneChamps = {};
        (p.recentMatches || []).forEach(m => {
          if (!m.lane || m.lane === '?') return;
          const enKey = Object.keys(LANE_KO).find(k => LANE_KO[k] === m.lane);
          if (enKey) {
            if (!laneChamps[enKey]) laneChamps[enKey] = {};
            laneChamps[enKey][m.champion] = (laneChamps[enKey][m.champion] || 0) + 1;
          }
        });

        const laneRows = laneOrder.map(lane => {
          const stats = p.laneStats?.[lane];
          if (!stats || stats.n === 0) return '';
          const ratio = (stats.n / totalScan * 100).toFixed(0);
          const wrVal = (stats.w / stats.n * 100).toFixed(0);
          const c = wrVal >= 55 ? '#3ecf78' : wrVal >= 50 ? '#dde4f0' : '#ef5350';
          const top3 = Object.entries(laneChamps[lane] || {}).sort((a,b)=>b[1]-a[1]).slice(0,3);
          const icons = top3.map(([ch, cnt]) => `
            <div class="champ-wrap" style="width:24px">
              <img src="https://ddragon.leagueoflegends.com/cdn/img/champion/tiles/${ch}_0.jpg"
                onerror="this.src='https://ddragon.leagueoflegends.com/cdn/15.4.1/img/champion/${ch}.png'"
                style="width:24px;height:24px;border-radius:3px;border:1px solid var(--border)" alt="${ch}">
              <span class="champ-lv" style="font-size:0.5rem">${cnt}</span>
            </div>`).join('');

          return `
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;background:rgba(255,255,255,0.03);padding:4px 8px;border-radius:4px">
            <span style="font-size:0.75rem;font-weight:700;width:35px;color:var(--gold)">${LANE_KO[lane]}</span>
            <div style="flex:1;font-size:0.68rem;color:var(--muted)">
              ${stats.n}íŒ (${ratio}%) Â· ìŠ¹ë¥  <span style="color:${c}">${wrVal}%</span>
            </div>
            <div style="display:flex;gap:3px">${icons}</div>
          </div>`;
        }).join('');

        const laneHtml = laneRows ? `<div style="margin-top:16px"><div style="font-size:0.7rem;color:var(--muted);margin-bottom:6px;font-weight:700">ë¼ì¸ë³„ ìƒì„¸ (ìµœê·¼ ${totalScan}íŒ)</div>${laneRows}</div>` : '';

        // 2. ì‹œì¦Œ ëª¨ìŠ¤íŠ¸
        let seasonMostHtml = '';
        if (p.seasonMost?.length) {
          const rows = p.seasonMost.map(c => {
            const wc = c.winRate >= 55 ? '#3ecf78' : c.winRate >= 50 ? '#dde4f0' : '#ef5350';
            const kc = c.kda >= 4 ? '#3ecf78' : c.kda >= 2.5 ? '#d4af37' : '#ef5350';
            return `
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;background:rgba(255,255,255,0.02);padding:3px 6px;border-radius:4px">
              <img src="${c.imgUrl}" style="width:28px;height:28px;border-radius:4px;border:1px solid var(--border)" alt="${c.name}" onerror="this.src='https://ddragon.leagueoflegends.com/cdn/15.4.1/img/profileicon/29.png'">
              <div style="flex:1;font-size:0.68rem">
                <div style="font-weight:700;font-size:0.72rem">${c.name}</div>
                <div style="color:var(--muted)">${c.games}íŒ Â· ìŠ¹ë¥  <span style="color:${wc}">${c.winRate}%</span></div>
              </div>
              <div style="text-align:right;font-size:0.68rem;color:${kc};font-weight:700">KDA ${c.kda}</div>
            </div>`;
          }).join('');
          seasonMostHtml = `<div style="margin-top:16px"><div style="font-size:0.7rem;color:var(--muted);margin-bottom:6px;font-weight:700">ì‹œì¦Œ ëª¨ìŠ¤íŠ¸ (ìµœê·¼ ${totalScan}íŒ)</div>${rows}</div>`;
        }

        // 3. ì „ì²´ ìˆ™ë ¨ë„
        const masteryHtml = p.topChamps?.length ? `
          <div style="margin-top:16px">
            <div style="font-size:0.7rem;color:var(--muted);margin-bottom:8px;font-weight:700">ëª¨ìŠ¤íŠ¸ ì±”í”¼ì–¸ (ì „ì²´ ìˆ™ë ¨ë„ TOP 10)</div>
            <div style="display:grid;grid-template-columns:repeat(5, 1fr);gap:8px 6px">
              ${p.topChamps.map(c => `
                <div style="text-align:center">
                  <div class="champ-wrap" style="width:100%;margin-bottom:2px">
                    <img src="${c.imgUrl}" style="width:100%;height:auto;aspect-ratio:1;border-radius:6px" alt="${c.name}" onerror="this.style.display='none'">
                    <span class="champ-lv">M${c.level}</span>
                    <div class="champ-tooltip">${c.name}</div>
                  </div>
                  <div style="font-size:0.58rem;color:var(--gold);font-weight:700">${(c.points/1000).toFixed(0)}K</div>
                </div>`).join('')}
            </div>
          </div>` : '';

        // 4. ìƒì„¸ ì „ì 
        let matchHtml = '';
        if (p.recentMatches?.length) {
          const ms = p.recentMatches;
          const wins = ms.filter(m => m.win).length;
          const wr = (wins / ms.length * 100).toFixed(0);
          const wc = wr >= 55 ? '#3ecf78' : wr >= 50 ? '#dde4f0' : '#ef5350';
          const rows = ms.map((m, idx) => {
            const kc = m.kda>=4?'#3ecf78':m.kda>=2.5?'#d4af37':'#ef5350';
            const tlId = `${uid}_${idx}`;
            const itemImgs = (m.items || [0,0,0,0,0,0,0]).map(iid => {
              if (iid === 0) return `<div class="match-item"></div>`;
              return `<img class="match-item" src="https://ddragon.leagueoflegends.com/cdn/15.4.1/img/item/${iid}.png" onerror="this.style.display='none'" alt="${iid}">`;
            }).join('');
            return `<div class="match-row" style="flex-direction:column;align-items:flex-start;padding:6px 0">
              <div style="display:flex;width:100%;align-items:center;gap:5px">
                <img class="match-champ" src="https://ddragon.leagueoflegends.com/cdn/img/champion/tiles/${m.champion}_0.jpg" onerror="this.src='https://ddragon.leagueoflegends.com/cdn/15.4.1/img/champion/${m.champion}.png'" alt="${m.champion}">
                <span class="match-wl ${m.win?'w':'l'}">${m.win?'W':'L'}</span>
                <span class="match-name">${m.champion}</span>
                <span class="match-kda" style="color:${kc}">${m.kills}/${m.deaths}/${m.assists}</span>
                <span class="match-meta">${m.lane}Â·${m.duration}</span>
                <button class="tl-btn" onclick="loadTimeline('${m.matchId}',${m.participantId},'${tlId}')">ìƒì„¸</button>
              </div>
              <div class="match-items">${itemImgs}</div>
            </div><div class="tl-section" id="tl_${tlId}"></div>`;
          }).join('');
          matchHtml = `<button class="matches-toggle" style="margin-top:16px" onclick="toggleMatches('${uid}')">
            <span>ìµœê·¼ 20íŒ ì „ì  ìš”ì•½</span>
            <span style="color:${wc}">${wins}ìŠ¹ ${ms.length-wins}íŒ¨ (${wr}%) â–¼</span>
          </button><div class="matches-list" id="matches_${uid}" style="padding-top:6px">${rows}</div>`;
        }
        return laneHtml + seasonMostHtml + masteryHtml + matchHtml;
      })()}
      <div class="card-btns" style="display:flex;gap:4px">
        <button class="btn-icon" onclick="refreshPlayer('${esc(p.displayName)}')" title="Riot APIì—ì„œ ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê¸°">â†»</button>
        <button class="btn btn-rm" onclick="removePlayer('${esc(p.displayName)}')">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ íŒŒì›Œ ê·¸ë˜í”„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChart() {
  const ctx = document.getElementById('scoreChart').getContext('2d');
  if (chart) { chart.destroy(); chart = null; }
  if (!players.length) return;

  // ì¸ì›ìˆ˜ì— ë”°ë¥¸ ë†’ì´ ë™ì  ì„¤ì •
  const chartContainer = document.querySelector('.chart-container');
  const dynamicHeight = Math.max(250, players.length * 35 + 50);
  chartContainer.style.height = `${dynamicHeight}px`;

  const sorted = [...players].sort((a, b) => b.score - a.score);
  const labels = sorted.map(p => p.gameName);
  const data   = sorted.map(p => p.score);
  const bgs    = sorted.map(p => {
    const r = p.highestRank;
    return (tc(r?.tier) + 'bb');
  });
  const bords  = sorted.map(p => {
    const r = p.highestRank;
    return tc(r?.tier);
  });

  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ data, backgroundColor: bgs, borderColor: bords, borderWidth: 1, borderRadius: 4 }],
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => {
              const p = sorted[ctx.dataIndex];
              const r = p.highestRank;
              return [`ì ìˆ˜: ${ctx.raw.toLocaleString()}`, r ? `${r.queueType} ${tierLabel(r)}` : 'ì–¸ë­', `ì£¼ ë¼ì¸: ${p.primaryLaneKo}`];
            },
          },
        },
      },
      scales: {
        x: { grid: { color: '#252f4a' }, ticks: { color: '#7a8aaa' } },
        y: { grid: { display: false },   ticks: { color: '#dde4f0', font: { size: 12 } } },
      },
    },
  });
}

// â”€â”€ ë¼ì¸ë³„ ì ìˆ˜ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ê¸°ë³¸ í‹°ì–´ ì ìˆ˜ + í•´ë‹¹ ë¼ì¸ ìŠ¹ë¥ /KDA/25ë¶„ ì „í›„ ìŠ¹ë¥  ë³´ì •
const LANE_EN_TO_KO = { TOP:'íƒ‘', JUNGLE:'ì •ê¸€', MIDDLE:'ë¯¸ë“œ', BOTTOM:'ì›ë”œ', UTILITY:'ì„œí¬í„°' };

function calcLaneStats(player, laneEn) {
  const laneKo = LANE_EN_TO_KO[laneEn];
  const ms = (player.recentMatches || []).filter(m => m.lane === laneKo);
  const n  = ms.length;
  if (!n) return { score: player.score, wr: null, avgKda: null, earlyWr: null, lateWr: null, games: 0 };

  const wins   = ms.filter(m => m.win).length;
  const wr     = wins / n * 100;
  const avgKda = ms.reduce((s, m) => s + m.kda, 0) / n;

  const early  = ms.filter(m => (m.durationSec || 9999) < 1500);
  const late   = ms.filter(m => (m.durationSec || 0)   >= 1500);
  const earlyWr = early.length ? early.filter(m => m.win).length / early.length * 100 : null;
  const lateWr  = late.length  ? late.filter(m => m.win).length  / late.length  * 100 : null;

  // ë³´ì •: ìŠ¹ë¥  Â±15ì /%, KDA Â±30ì /1.0
  const wrBonus  = (wr - 50) * 15;
  const kdaBonus = (avgKda - 2) * 30;
  const score    = Math.round(player.score + wrBonus + kdaBonus);

  return { score, wr, avgKda, earlyWr, lateWr, games: n };
}

// â”€â”€ ë¼ì¸ë³„ í‹°ì–´ ê³„ì‚° (íŒìˆ˜ ê°€ì¤‘ ìŠ¹ë¥ ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// adjustedWR = winRate * (1 - 1/(games+1))
// 1íŒ 100% â†’ 50%, 5íŒ 70% â†’ 58.3%, 10íŒ 60% â†’ 54.5%
const LANE_TIERS = [
  { min: 65, label: 'S+', color: '#ffe066', bg: '#ffe06622' },
  { min: 55, label: 'S',  color: '#ef5350', bg: '#ef535022' },
  { min: 48, label: 'A',  color: '#ab47bc', bg: '#ab47bc22' },
  { min: 40, label: 'B',  color: '#4fc3f7', bg: '#4fc3f722' },
  { min: 30, label: 'C',  color: '#3ecf78', bg: '#3ecf7822' },
  { min: 0,  label: 'D',  color: '#8d8d8d', bg: '#8d8d8d22' },
];

function calcLaneTier(player, laneEn) {
  const laneKo = LANE_EN_TO_KO[laneEn];
  const ms = (player.recentMatches || []).filter(m => m.lane === laneKo);
  const games = ms.length;
  if (!games) return null;
  const wins = ms.filter(m => m.win).length;
  const wr = wins / games * 100;
  const adjusted = wr * (1 - 1 / (games + 1));
  return LANE_TIERS.find(t => adjusted >= t.min) || LANE_TIERS[LANE_TIERS.length - 1];
}

// â”€â”€ ë¼ì¸ë³„ ìˆœìœ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLanes() {
  LANES.forEach(lane => {
    const col     = document.getElementById(`lane-${lane}`);
    const header  = col.querySelector('.lane-head').outerHTML;
    const lp = players
      .filter(p => (p.laneCounts?.[lane] || 0) > 0)
      .sort((a, b) => b.score - a.score);

    if (!lp.length) {
      col.innerHTML = header + `<div class="lane-empty">ì—†ìŒ</div>`;
      return;
    }
    lp.sort((a, b) => calcLaneStats(b, lane).score - calcLaneStats(a, lane).score);

    col.innerHTML = header + lp.map((p, i) => {
      const r = p.solo || p.flex;
      const color = tc(r?.tier);
      const isPrimary = p.primaryLane === lane;
      const st = calcLaneStats(p, lane);
      const wrColor = st.wr >= 55 ? '#3ecf78' : st.wr >= 50 ? '#dde4f0' : '#ef5350';
      const tier = calcLaneTier(p, lane);
      const tierHtml = tier ? `<span class="lane-tier-badge" style="background:${tier.bg};color:${tier.color}">${tier.label}</span>` : '';
      const subLine = st.games
        ? [
            st.wr    !== null ? `<span style="color:${wrColor}">${st.wr.toFixed(0)}%</span>` : '',
            st.avgKda !== null ? `KDA ${st.avgKda.toFixed(1)}` : '',
            st.earlyWr !== null ? `25ë¶„â†‘ ${st.earlyWr.toFixed(0)}%` : '',
            st.lateWr  !== null ? `25ë¶„â†“ ${st.lateWr.toFixed(0)}%`  : '',
          ].filter(Boolean).join(' Â· ')
        : '';
      return `
      <div class="lane-row" style="${isPrimary ? '' : 'opacity:0.65'}">
        <span class="lane-num">${i + 1}</span>
        <div class="lane-info">
          <div class="lane-pname" title="${p.displayName}">
            ${p.gameName}${isPrimary ? '' : ` <span style="color:var(--muted);font-size:.65rem">(ë¶€)</span>`}
            <span style="color:var(--muted);font-size:.65rem"> ${st.games}íŒ</span>
            ${tierHtml}
          </div>
          <div style="font-size:0.7rem;color:${color}">${r ? tierLabel(r) : 'ì–¸ë­'}</div>
          ${subLine ? `<div style="font-size:0.65rem;color:var(--muted)">${subLine}</div>` : ''}
        </div>
        <span class="lane-score">${st.score.toLocaleString()}</span>
      </div>`;
    }).join('');
  });
}

// â”€â”€ ì„ íƒ í† ê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePlayer(dn) {
  selected.has(dn) ? selected.delete(dn) : selected.add(dn);
  renderToggles();
  updateSelCount();
}

function renderToggles() {
  document.getElementById('toggleGrid').innerHTML = players.map(p => {
    const on    = selected.has(p.displayName);
    const color = tc(p.solo?.tier || p.flex?.tier);
    return `<div class="p-toggle${on ? ' on' : ''}" onclick="togglePlayer('${esc(p.displayName)}')">
      ${p.gameName}
      ${p.solo?.tier ? `<span style="color:${color}">â—</span>` : ''}
    </div>`;
  }).join('');
}

function updateSelCount() {
  const n  = selected.size;
  const el = document.getElementById('selCount');
  const odd = n > 0 && n % 2 !== 0;
  el.textContent  = `${n}ëª… ì„ íƒë¨${odd ? ' â€” ì§ìˆ˜ë¡œ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤' : ''}`;
  el.className    = `sel-count${odd ? ' warn' : ''}`;
}

// â”€â”€ ê³ ì •/ë¶„ë¦¬ ê·¸ë£¹ ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fixedGroupsData = [];
let separateGroupsData = [];
let activeDropdown = null;

function toggleConstraint(type) {
  const body  = document.getElementById(`${type}Body`);
  const arrow = document.getElementById(`${type}Arrow`);
  body.classList.toggle('open');
  arrow.classList.toggle('open');
}

function addGroup(type) {
  const data = type === 'fixed' ? fixedGroupsData : separateGroupsData;
  data.push([]);
  renderGroups(type);
}

function removeGroup(type, idx) {
  const data = type === 'fixed' ? fixedGroupsData : separateGroupsData;
  data.splice(idx, 1);
  renderGroups(type);
}

function removeMember(type, groupIdx, memberDn) {
  const data = type === 'fixed' ? fixedGroupsData : separateGroupsData;
  data[groupIdx] = data[groupIdx].filter(dn => dn !== memberDn);
  if (data[groupIdx].length === 0) data.splice(groupIdx, 1);
  renderGroups(type);
}

function showPlayerSelect(type, groupIdx, btnEl) {
  closeDropdown();
  const data = type === 'fixed' ? fixedGroupsData : separateGroupsData;
  const group = data[groupIdx];
  const selPlayers = players.filter(p => selected.has(p.displayName));

  const dropdown = document.createElement('div');
  dropdown.className = 'group-player-select';
  dropdown.innerHTML = selPlayers.map(p => {
    const inGroup = group.includes(p.displayName);
    return `<div class="group-player-option${inGroup ? ' disabled' : ''}"
      onclick="${inGroup ? '' : `addMemberToGroup('${type}',${groupIdx},'${esc(p.displayName)}')`}">
      ${p.gameName}${inGroup ? ' (ì¶”ê°€ë¨)' : ''}
    </div>`;
  }).join('');

  if (!selPlayers.length) {
    dropdown.innerHTML = `<div style="padding:8px;color:var(--muted);font-size:0.75rem">ì°¸ê°€ ì¸ì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</div>`;
  }

  btnEl.parentElement.style.position = 'relative';
  dropdown.style.top = '100%';
  dropdown.style.left = '0';
  btnEl.parentElement.appendChild(dropdown);
  activeDropdown = dropdown;

  setTimeout(() => {
    document.addEventListener('click', closeDropdown, { once: true });
  }, 0);
}

function closeDropdown() {
  if (activeDropdown) { activeDropdown.remove(); activeDropdown = null; }
}

function addMemberToGroup(type, groupIdx, displayName) {
  const data = type === 'fixed' ? fixedGroupsData : separateGroupsData;
  if (!data[groupIdx].includes(displayName)) data[groupIdx].push(displayName);
  closeDropdown();
  renderGroups(type);
}

function renderGroups(type) {
  const data = type === 'fixed' ? fixedGroupsData : separateGroupsData;
  const container = document.getElementById(`${type}Groups`);
  const countEl = document.getElementById(`${type}GroupCount`);
  const activeCount = data.filter(g => g.length >= 2).length;
  countEl.textContent = activeCount > 0 ? `( ${activeCount} ê·¸ë£¹ )` : '';

  container.innerHTML = data.map((group, idx) => `
    <div class="group-card">
      <div class="group-header">
        <span class="group-label">ê·¸ë£¹ ${idx + 1}</span>
        <button class="btn-rm" onclick="removeGroup('${type}', ${idx})" style="font-size:0.7rem">ì‚­ì œ</button>
      </div>
      <div class="group-members">
        ${group.map(dn => {
          const p = players.find(pl => pl.displayName === dn);
          return p ? `<div class="group-member">
            ${p.gameName}
            <span class="rm" onclick="removeMember('${type}', ${idx}, '${esc(dn)}')">âœ•</span>
          </div>` : '';
        }).join('')}
        <button class="group-add-btn" onclick="showPlayerSelect('${type}', ${idx}, this)">+ ì¶”ê°€</button>
      </div>
    </div>
  `).join('');
}

function cleanupGroups() {
  const selNames = new Set(players.filter(p => selected.has(p.displayName)).map(p => p.displayName));
  [fixedGroupsData, separateGroupsData].forEach(groups => {
    for (let i = groups.length - 1; i >= 0; i--) {
      groups[i] = groups[i].filter(dn => selNames.has(dn));
      if (groups[i].length === 0) groups.splice(i, 1);
    }
  });
  renderGroups('fixed');
  renderGroups('separate');
}

// â”€â”€ íŒ€ êµ¬ì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function balanceTeams(mode = 'balance') {
  const sel = players.filter(p => selected.has(p.displayName));
  if (sel.length < 2)  { alert('ìµœì†Œ 2ëª…ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
  if (sel.length % 2)  { alert('ì§ìˆ˜ ì¸ì›ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤'); return; }

  // Build constraint indices relative to `sel` array
  const selNames = sel.map(p => p.displayName);
  const toIndices = (groups) => groups
    .map(g => g.map(dn => selNames.indexOf(dn)).filter(i => i !== -1))
    .filter(g => g.length >= 2);

  const fixedG    = toIndices(fixedGroupsData);
  const separateG = toIndices(separateGroupsData);

  const resultEl = document.getElementById('teamsResult');
  resultEl.innerHTML = `<div class="loading-box"><span class="spinner"></span> íŒ€ êµ¬ì„± ê³„ì‚° ì¤‘â€¦</div>`;

  try {
    const res  = await fetch('/api/balance', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ players: sel, mode, fixedGroups: fixedG, separateGroups: separateG }),
    });
    const data = await res.json();
    if (!res.ok) { resultEl.innerHTML = `<div class="err">${data.error}</div>`; return; }
    renderTeams(data);
  } catch (e) {
    resultEl.innerHTML = `<div class="err">ì„œë²„ ì˜¤ë¥˜: ${e.message}</div>`;
  }
}

  let lastTeamData = null; // ë””ì½” ì „ì†¡ìš© ì„ì‹œ ì €ì¥

function renderTeams(data) {
  const { team1, team2, team1Score, team2Score, scoreDiff, laneBalanced, mode } = data;
  lastTeamData = data;

  function playerRow(p) {
    const r     = p.solo || p.flex;
    const color = tc(r?.tier);
    // ëœë¤ ë¼ì¸ ë°°ì •ì¸ ê²½ìš° í• ë‹¹ëœ ë¼ì¸ì„ ê°•ì¡°í•´ì„œ í‘œì‹œ
    const laneDisplay = p.assignedLaneKo 
      ? `<span class="lane-tag" style="background:var(--gold);color:#0a0e1a;border-color:var(--gold)">${p.assignedLaneKo}</span>
         <span style="font-size:0.65rem;color:var(--muted)"> (ì£¼:${p.primaryLaneKo})</span>`
      : `<span class="lane-tag">${p.primaryLaneKo}</span>`;

    return `
    <div class="team-player">
      <img class="team-icon" src="${p.iconUrl}"
        onerror="this.src='https://ddragon.leagueoflegends.com/cdn/15.4.1/img/profileicon/29.png'" alt="">
      ${laneDisplay}
      <div class="team-player-info">
        <div class="team-player-name">${p.gameName}</div>
        <div class="team-player-tier" style="color:${color}">${r ? tierLabel(r) : 'ì–¸ë­'}</div>
      </div>
      <div class="team-player-score">${p.score.toLocaleString()}</div>
    </div>`;
  }

  function teamCard(players, cls, label, score) {
    const wr = players.filter(p => p.solo).reduce((s, p) => s + p.solo.wins, 0);
    const lr = players.filter(p => p.solo).reduce((s, p) => s + p.solo.losses, 0);
    const avg = players.length ? Math.round(score / players.length) : 0;
    return `
    <div class="team-card ${cls}">
      <div class="team-head">
        <span>${label}</span>
        <span style="font-size:.82rem;opacity:.75">í•©ê³„ ${score.toLocaleString()}pt</span>
      </div>
      ${players.map(playerRow).join('')}
      <div class="team-foot">
        <span>í‰ê·  ${avg.toLocaleString()}pt</span>
        ${wr + lr > 0 ? `<span>${wr}W ${lr}L</span>` : ''}
      </div>
    </div>`;
  }

  const total  = team1Score + team2Score;
  const diffPct = total > 0 ? ((scoreDiff / (total / 2)) * 100).toFixed(1) : 0;
  
  let bannerText = `ì ìˆ˜ ì°¨ì´: <strong>${scoreDiff.toLocaleString()}pt</strong> (${diffPct}%)`;
  if (mode === 'balance') {
    bannerText += ` &nbsp;Â·&nbsp; ${laneBalanced ? '<span style="color:#3ecf78">ë¼ì¸ ë°¸ëŸ°ìŠ¤ ì™„ë£Œ âœ“</span>' : '<span style="color:#e8c86b">ë¼ì¸ ë¶ˆê· í˜• ì£¼ì˜</span>'}`;
  } else if (mode === 'random') {
    bannerText = `ğŸ² <strong>ì™„ì „ ëœë¤ ë°°ì •</strong> ê²°ê³¼ì…ë‹ˆë‹¤.`;
  } else {
    bannerText = `ğŸ”€ <strong>ëœë¤ ë°°ì • + ë¼ì¸ ë¬´ì‘ìœ„ í• ë‹¹</strong> ê²°ê³¼ì…ë‹ˆë‹¤.`;
  }

  document.getElementById('teamsResult').innerHTML = `
  <div class="teams-grid">
    ${teamCard(team1, 't1', 'ğŸ”µ íŒ€ 1', team1Score)}
    ${teamCard(team2, 't2', 'ğŸ”´ íŒ€ 2', team2Score)}
    <div class="diff-banner">
      ${bannerText}
      <button class="btn btn-discord" onclick="sendToDiscord()">ğŸ“¢ ë””ì½”ë¡œ ê²°ê³¼ ì „ì†¡</button>
    </div>
  </div>`;
}

async function sendToDiscord() {
  if (!lastTeamData) return;
  const btn = document.querySelector('.btn-discord');
  const originalText = btn.textContent;
  
  btn.disabled = true;
  btn.textContent = 'â³ ì „ì†¡ ì¤‘...';

  try {
    const res = await fetch('/api/discord', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(lastTeamData)
    });
    const data = await res.json();
    if (data.success) {
      btn.textContent = 'âœ… ì „ì†¡ ì™„ë£Œ!';
      btn.style.background = '#3ecf78';
    } else {
      alert('ì „ì†¡ ì‹¤íŒ¨: ' + data.error);
      btn.textContent = originalText;
      btn.disabled = false;
    }
  } catch (e) {
    alert('ì˜¤ë¥˜: ' + e.message);
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

function toggleMatches(uid) {
  document.getElementById(`matches_${uid}`).classList.toggle('open');
}

const MONSTER_ICON = {
  DRAGON:'ğŸ‰', BARON_NASHOR:'ğŸŸ£', RIFTHERALD:'ğŸ‘', HORDE:'ğŸ›',
};

async function loadTimeline(matchId, pid, tlId) {
  const el = document.getElementById(`tl_${tlId}`);
  // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
  if (el.classList.contains('open')) { el.classList.remove('open'); return; }
  // ì´ë¯¸ ë¡œë“œëìœ¼ë©´ ë°”ë¡œ ì—´ê¸°
  if (el.dataset.loaded) { el.classList.add('open'); return; }

  el.innerHTML = `<div style="padding:6px;color:var(--muted);font-size:0.75rem"><span class="spinner"></span> íƒ€ì„ë¼ì¸ ë¡œë“œ ì¤‘â€¦</div>`;
  el.classList.add('open');

  try {
    const res  = await fetch(`/api/timeline/${matchId}/${pid}`);
    const data = await res.json();
    if (!res.ok) { el.innerHTML = `<div style="color:#ef5350;font-size:0.75rem;padding:6px">${data.error}</div>`; return; }

    if (!data.events.length) { el.innerHTML = `<div style="color:var(--muted);font-size:0.75rem;padding:6px">ì´ë²¤íŠ¸ ì—†ìŒ</div>`; return; }

    el.innerHTML = data.events.map(e => {
      if (e.type === 'item') return `
        <div class="tl-row">
          <span class="tl-min">${e.minute}ë¶„</span>
          <img class="tl-icon" src="${e.imgUrl}" alt="" onerror="this.style.display='none'">
          <span class="tl-label">${e.name}</span>
        </div>`;
      if (e.type === 'kill') return `
        <div class="tl-row">
          <span class="tl-min">${e.minute}ë¶„</span>
          <span style="font-size:0.85rem">âš”</span>
          <span class="tl-label" style="color:#3ecf78">í‚¬</span>
        </div>`;
      if (e.type === 'death') return `
        <div class="tl-row">
          <span class="tl-min">${e.minute}ë¶„</span>
          <span style="font-size:0.85rem">ğŸ’€</span>
          <span class="tl-label" style="color:#ef5350">ë°ìŠ¤</span>
        </div>`;
      if (e.type === 'assist') return `
        <div class="tl-row">
          <span class="tl-min">${e.minute}ë¶„</span>
          <span style="font-size:0.85rem">ğŸ¤</span>
          <span class="tl-label" style="color:#d4af37">ì–´ì‹œìŠ¤íŠ¸</span>
        </div>`;
      if (e.type === 'objective') return `
        <div class="tl-row">
          <span class="tl-min">${e.minute}ë¶„</span>
          <span style="font-size:0.85rem">${MONSTER_ICON[e.monster] || 'ğŸ¯'}</span>
          <span class="tl-label">${e.name}</span>
        </div>`;
      return '';
    }).join('');
    el.dataset.loaded = '1';
  } catch(err) {
    el.innerHTML = `<div style="color:#ef5350;font-size:0.75rem;padding:6px">ì˜¤ë¥˜: ${err.message}</div>`;
  }
}

// â”€â”€ ì €ì¥ëœ ì†Œí™˜ì‚¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TIER_KO_SHORT = {
  IRON:'ì•„ì´ì–¸', BRONZE:'ë¸Œë¡ ì¦ˆ', SILVER:'ì‹¤ë²„', GOLD:'ê³¨ë“œ',
  PLATINUM:'í”Œë˜í‹°ë„˜', EMERALD:'ì—ë©”ë„ë“œ', DIAMOND:'ë‹¤ì´ì•„',
  MASTER:'ë§ˆìŠ¤í„°', GRANDMASTER:'ê·¸ëœë§ˆ', CHALLENGER:'ì±Œë¦°ì €',
};

async function loadSavedPlayers() {
  try {
    const res = await fetch('/api/summoners');
    if (!res.ok) return;
    renderSavedList(await res.json());
  } catch (e) { /* ignore */ }
}

function renderSavedList(summaries) {
  const section = document.getElementById('savedSection');
  const list    = document.getElementById('savedList');
  if (!summaries || !summaries.length) { section.style.display = 'none'; return; }
  section.style.display = '';

  list.innerHTML = summaries.map(s => {
    const alreadyAdded = players.some(p => p.displayName === s.displayName);
    const tier  = s.tier ? (TIER_KO_SHORT[s.tier] || s.tier) : 'ì–¸ë­';
    const rankStr = (s.rank && !['MASTER','GRANDMASTER','CHALLENGER'].includes(s.tier))
      ? ` ${s.rank}` : '';
    const lpStr = s.lp != null ? ` ${s.lp}LP` : '';
    const color = tc(s.tier);
    return `<div class="saved-item">
      <img src="${s.iconUrl || ''}" style="width:36px;height:36px;border-radius:50%;border:1px solid var(--border);flex-shrink:0"
        onerror="this.style.display='none'" alt="">
      <div class="saved-item-info">
        <div class="saved-item-name" title="${s.displayName}">
          ${s.gameName}<span style="color:var(--muted);font-weight:400"> #${s.tagLine}</span>
        </div>
        <div class="saved-item-meta" style="color:${color}">${tier}${rankStr}${lpStr}
          <span style="color:var(--muted)"> Â· ${s.cachedAt || ''}</span>
        </div>
      </div>
      <button class="btn btn-gold" style="padding:4px 10px;font-size:0.76rem;flex-shrink:0"
        onclick="loadFromSaved('${esc(s.displayName)}')" ${alreadyAdded ? 'disabled' : ''}>
        ${alreadyAdded ? 'ì¶”ê°€ë¨' : 'ë¶ˆëŸ¬ì˜¤ê¸°'}
      </button>
      <button class="btn-icon" onclick="deleteSaved('${esc(s.displayName)}')"
        title="ì €ì¥ ëª©ë¡ì—ì„œ ì‚­ì œ" style="flex-shrink:0">ğŸ—‘</button>
    </div>`;
  }).join('');
}

async function loadFromSaved(displayName) {
  const errEl = document.getElementById('inputErr');
  errEl.textContent = '';
  if (players.find(p => p.displayName === displayName)) {
    errEl.textContent = 'ì´ë¯¸ ì¶”ê°€ëœ í”Œë ˆì´ì–´ì…ë‹ˆë‹¤'; return;
  }
  try {
    const res  = await fetch(`/api/player/${encodeURIComponent(displayName)}`);
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.error || 'ì˜¤ë¥˜'; return; }
    players.push(data);
    selected.add(data.displayName);
    renderAll();
    loadSavedPlayers();
  } catch (e) { errEl.textContent = 'ì˜¤ë¥˜: ' + e.message; }
}

async function loadAllSaved() {
  const btn = document.getElementById('loadAllBtn');
  btn.disabled = true;
  const orig = btn.textContent;

  try {
    const res = await fetch('/api/summoners');
    const summaries = await res.json();
    if (!summaries.length) { btn.textContent = orig; btn.disabled = false; return; }

    let loaded = 0;
    for (const s of summaries) {
      if (players.find(p => p.displayName === s.displayName)) continue;
      btn.textContent = `(${++loaded}) ${s.gameName} ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`;
      try {
        const r    = await fetch(`/api/player/${encodeURIComponent(s.displayName)}`);
        const data = await r.json();
        if (r.ok) {
          players.push(data);
          selected.add(data.displayName);
        }
      } catch (e) { /* ê°œë³„ ì‹¤íŒ¨ ë¬´ì‹œ */ }
    }
    renderAll();
    loadSavedPlayers();
    btn.textContent = 'âœ“ ì™„ë£Œ';
    setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 2000);
  } catch (e) {
    btn.textContent = orig;
    btn.disabled = false;
  }
}

async function refreshAllSaved() {
  const btn = document.getElementById('refreshAllBtn');
  btn.disabled = true;
  const orig = btn.textContent;

  try {
    const res = await fetch('/api/summoners');
    const summaries = await res.json();
    if (!summaries.length) { btn.textContent = orig; btn.disabled = false; return; }

    for (let i = 0; i < summaries.length; i++) {
      const s = summaries[i];
      btn.textContent = `(${i + 1}/${summaries.length}) ${s.gameName} ì¡°íšŒ ì¤‘â€¦`;
      try {
        const r    = await fetch(`/api/player/${encodeURIComponent(s.displayName)}?refresh=true`);
        const data = await r.json();
        if (r.ok) {
          const idx = players.findIndex(p => p.displayName === s.displayName);
          if (idx !== -1) players[idx] = data;
        }
      } catch (e) { /* ê°œë³„ ì‹¤íŒ¨ ë¬´ì‹œ */ }
    }
    renderAll();
    loadSavedPlayers();
    btn.textContent = 'âœ“ ì™„ë£Œ';
    setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 2000);
  } catch (e) {
    btn.textContent = orig;
    btn.disabled = false;
  }
}

async function deleteSaved(displayName) {
  if (!confirm(`'${displayName}' ë¥¼ ì €ì¥ ëª©ë¡ì—ì„œ ì‚­ì œí• ê¹Œìš”?`)) return;
  try {
    await fetch(`/api/summoner/${encodeURIComponent(displayName)}`, { method: 'DELETE' });
    loadSavedPlayers();
  } catch (e) { alert('ì˜¤ë¥˜: ' + e.message); }
}

async function refreshPlayer(displayName) {
  // ì¹´ë“œì˜ â†» ë²„íŠ¼ ë¡œë”© í‘œì‹œ
  const nameEl = document.querySelector(`.p-name[title="${displayName}"]`);
  const btn = nameEl?.closest('.p-card')?.querySelector('.btn-icon');
  if (btn) { btn.textContent = 'â€¦'; btn.disabled = true; }
  try {
    const res  = await fetch(`/api/player/${encodeURIComponent(displayName)}?refresh=true`);
    const data = await res.json();
    if (!res.ok) { document.getElementById('inputErr').textContent = data.error; return; }
    const idx = players.findIndex(p => p.displayName === displayName);
    if (idx !== -1) players[idx] = data;
    renderAll();
    await loadSavedPlayers();
  } catch (e) {
    document.getElementById('inputErr').textContent = 'ì˜¤ë¥˜: ' + e.message;
  }
}

// Enter í‚¤ ì§€ì›
document.getElementById('riotInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') addPlayer();
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì†Œí™˜ì‚¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
loadSavedPlayers();
</script>
</body>
</html>
